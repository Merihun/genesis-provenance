// Genesis Provenance - Prisma Schema for Phase 1

generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/genesis_provenance/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// User roles enum
enum UserRole {
  collector
  reseller
  partner
  admin
}

// Organization types enum
enum OrganizationType {
  individual
  reseller
  partner
  enterprise
}

// Item status enum
enum ItemStatus {
  pending
  verified
  flagged
  rejected
}

// Contact submission user types
enum ContactUserType {
  collector
  reseller
  partner
  other
}

// Contact submission status
enum ContactStatus {
  new
  contacted
  converted
  archived
}

// Media asset types
enum MediaAssetType {
  photo
  document
  certificate
}

// Provenance event types
enum ProvenanceEventType {
  registered
  reviewed
  status_changed
  ownership_transfer
  certificate_issued
  note_added
  restoration_work
  service_record
  concours_event
  appraisal
  inspection
}

// Subscription status
enum SubscriptionStatus {
  active
  cancelled
  past_due
  incomplete
  trialing
}

// Subscription plan types
enum SubscriptionPlan {
  collector
  reseller
  partner
  enterprise
}

// Team member roles
enum TeamRole {
  owner
  admin
  editor
  viewer
}

// Team invite status
enum InviteStatus {
  pending
  accepted
  declined
  expired
}

// Organizations table
model Organization {
  id        String           @id @default(uuid())
  name      String
  type      OrganizationType @default(individual)
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  users         User[]
  items         Item[]
  subscriptions Subscription[]
  teamMembers   TeamMember[]
  teamInvites   TeamInvite[]

  @@map("organizations")
}

// Users table
model User {
  id             String       @id @default(uuid())
  email          String       @unique
  passwordHash   String       @map("password_hash")
  fullName       String       @map("full_name")
  role           UserRole     @default(collector)
  organizationId String?      @map("organization_id")
  emailVerified  Boolean      @default(false) @map("email_verified")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  organization     Organization?     @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  itemsCreated     Item[]
  provenanceEvents ProvenanceEvent[]
  auditLogs        AuditLog[]
  teamMemberships  TeamMember[]

  @@index([email])
  @@index([organizationId])
  @@map("users")
}

// Item categories table
model ItemCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  items Item[]

  @@map("item_categories")
}

// Items table
model Item {
  id              String      @id @default(uuid())
  organizationId  String      @map("organization_id")
  createdByUserId String      @map("created_by_user_id")
  categoryId      String      @map("category_id")
  
  // Basic details
  brand           String?
  model           String?
  year            Int?
  referenceNumber String?     @map("reference_number")
  serialNumber    String?     @map("serial_number")
  
  // Luxury car specific
  vin             String?                              // Vehicle Identification Number
  makeModel       String?     @map("make_model")       // e.g., "Ferrari 275 GTB/4"
  matchingNumbers Boolean?    @map("matching_numbers") // Engine/chassis match
  
  // Financial details
  purchaseDate    DateTime?   @map("purchase_date")
  purchasePrice   Decimal?    @map("purchase_price") @db.Decimal(12, 2)
  estimatedValue  Decimal?    @map("estimated_value") @db.Decimal(12, 2)
  
  // Status & authentication
  status          ItemStatus  @default(pending)
  riskScore       Int?        @map("risk_score")
  notes           String?     @db.Text
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User              @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  category        ItemCategory      @relation(fields: [categoryId], references: [id])
  mediaAssets     MediaAsset[]
  provenanceEvents ProvenanceEvent[]
  certificates    Certificate[]

  @@index([organizationId])
  @@index([createdByUserId])
  @@index([categoryId])
  @@index([status])
  @@index([vin])
  @@map("items")
}

// Contact submissions table (for waitlist/contact forms)
model ContactSubmission {
  id        String            @id @default(uuid())
  name      String
  email     String
  company   String?
  userType  ContactUserType   @map("user_type")
  message   String            @db.Text
  status    ContactStatus     @default(new)
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("contact_submissions")
}

// Media assets table (photos, documents, certificates)
model MediaAsset {
  id                String         @id @default(uuid())
  itemId            String         @map("item_id")
  type              MediaAssetType
  fileName          String         @map("file_name")
  cloudStoragePath  String         @map("cloud_storage_path")  // S3 key
  fileSize          Int            @map("file_size")            // in bytes
  mimeType          String         @map("mime_type")
  isPublic          Boolean        @default(false) @map("is_public")  // Public vs private S3 access
  uploadedAt        DateTime       @default(now()) @map("uploaded_at")

  // Relations
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([type])
  @@map("media_assets")
}

// Provenance events table (timeline of asset history)
model ProvenanceEvent {
  id          String               @id @default(uuid())
  itemId      String               @map("item_id")
  userId      String?              @map("user_id")
  eventType   ProvenanceEventType  @map("event_type")
  title       String
  description String?              @db.Text
  metadata    Json?                                // Additional structured data
  occurredAt  DateTime             @default(now()) @map("occurred_at")

  // Relations
  item Item  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([itemId])
  @@index([userId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("provenance_events")
}

// Certificates table (generated provenance certificates)
model Certificate {
  id              String   @id @default(uuid())
  itemId          String   @map("item_id")
  certificateToken String  @unique @map("certificate_token")  // For public sharing
  htmlContent     String   @db.Text @map("html_content")
  pdfStoragePath  String?  @map("pdf_storage_path")          // S3 key for PDF
  generatedAt     DateTime @default(now()) @map("generated_at")
  expiresAt       DateTime? @map("expires_at")
  isActive        Boolean  @default(true) @map("is_active")

  // Relations
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([certificateToken])
  @@map("certificates")
}

// Subscriptions table (Stripe integration)
model Subscription {
  id                 String             @id @default(uuid())
  organizationId     String             @map("organization_id")
  plan               SubscriptionPlan
  status             SubscriptionStatus @default(trialing)
  stripeCustomerId   String?            @map("stripe_customer_id")
  stripeSubscriptionId String?          @unique @map("stripe_subscription_id")
  currentPeriodStart DateTime?          @map("current_period_start")
  currentPeriodEnd   DateTime?          @map("current_period_end")
  cancelAtPeriodEnd  Boolean            @default(false) @map("cancel_at_period_end")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

// Audit logs table (security and compliance)
model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String                          // e.g., "item.create", "user.login", "settings.update"
  resource   String?                         // Resource type (item, user, org)
  resourceId String?  @map("resource_id")   // ID of the resource
  details    Json?                           // Additional context
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// Team members table (for collaboration)
model TeamMember {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  role           TeamRole @default(viewer)
  addedAt        DateTime @default(now()) @map("added_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("team_members")
}

// Team invites table (pending invitations)
model TeamInvite {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  email          String
  role           TeamRole     @default(viewer)
  status         InviteStatus @default(pending)
  inviteToken    String       @unique @map("invite_token")
  expiresAt      DateTime     @map("expires_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([inviteToken])
  @@index([status])
  @@map("team_invites")
}
